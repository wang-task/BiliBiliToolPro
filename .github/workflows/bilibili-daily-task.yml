# æ¯æ—¥ä»»åŠ¡

name: bilibili-daily-task


on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule: # è®¡åˆ’ä»»åŠ¡è§¦å‘
    - cron: '14 0 * * *' 
    # cronè¡¨è¾¾å¼ï¼Œæ—¶åŒºæ˜¯UTCæ—¶é—´ï¼Œæ¯”æˆ‘ä»¬æ—©8å°æ—¶ï¼Œå¦‚ä¸Šæ‰€è¡¨ç¤ºçš„æ˜¯æ¯å¤©0ç‚¹0åˆ†ï¼ˆ16+8=24ç‚¹æ•´ï¼‰
    # å»ºè®®æ¯ä¸ªäººé€šè¿‡è®¾ç½®åç§°ä¸º Production çš„ GitHub Environments æ¥è®¾å®šä¸ºè‡ªå·±çš„ç›®æ ‡è¿è¡Œæ—¶é—´ï¼ˆè¯¦ç»†è®¾ç½®æ–¹æ³•è§æ–‡æ¡£è¯´æ˜ï¼‰

env:
  ASPNETCORE_ENVIRONMENT: ${{secrets.ENV}} # è¿è¡Œç¯å¢ƒ
  Ray_BiliBiliCookies__1: ${{secrets.COOKIESTR}}
  Ray_BiliBiliCookies__2: ${{secrets.COOKIESTR2}}
  Ray_BiliBiliCookies__3: ${{secrets.COOKIESTR3}}
  # æ¨é€ï¼š
  Ray_Notification__IsSingleAccountSingleNotify: false
  Ray_Serilog__WriteTo__3__Args__botToken: ${{secrets.PUSHTGTOKEN}} # Telegram
  Ray_Serilog__WriteTo__3__Args__chatId: ${{secrets.PUSHTGCHATID}}
  Ray_Serilog__WriteTo__3__Args__restrictedToMinimumLevel: ${{secrets.PUSHTGLEVEL}}
  Ray_Serilog__WriteTo__4__Args__webHookUrl: ${{secrets.PUSHWEIXINURL}} # ä¼ä¸šå¾®ä¿¡
  Ray_Serilog__WriteTo__4__Args__restrictedToMinimumLevel: ${{secrets.PUSHWEIXINLEVEL}}
  Ray_Serilog__WriteTo__5__Args__webHookUrl: ${{secrets.PUSHDINGURL}} # é’‰é’‰
  Ray_Serilog__WriteTo__5__Args__restrictedToMinimumLevel: ${{secrets.PUSHDINGLEVEL}}
  Ray_Serilog__WriteTo__6__Args__scKey: ${{secrets.PUSHSCKEY}} # Serveré…±
  Ray_Serilog__WriteTo__6__Args__turboScKey: ${{secrets.PUSHSERVERTSCKEY}}
  Ray_Serilog__WriteTo__6__Args__restrictedToMinimumLevel: ${{secrets.PUSHSERVERLEVEL}}
  Ray_Serilog__WriteTo__7__Args__sKey: ${{secrets.PUSHCOOLSKEY}} # é…·æ¨
  Ray_Serilog__WriteTo__7__Args__restrictedToMinimumLevel: ${{secrets.PUSHCOOLLEVEL}}
  Ray_Serilog__WriteTo__8__Args__api: ${{secrets.PUSHOTHERAPI}} # è‡ªå®šä¹‰api
  Ray_Serilog__WriteTo__8__Args__placeholder: ${{secrets.PUSHOTHERPLACEHOLDER}}
  Ray_Serilog__WriteTo__8__Args__bodyJsonTemplate: ${{secrets.PUSHOTHERBODYJSONTEMPLATE}}
  Ray_Serilog__WriteTo__8__Args__restrictedToMinimumLevel: ${{secrets.PUSHOTHERLEVEL}}
  Ray_Serilog__WriteTo__9__Args__token: ${{secrets.PUSHPLUSTOKEN}} # PushPlus
  Ray_Serilog__WriteTo__9__Args__topic: ${{secrets.PUSHPLUSTOPIC}}
  Ray_Serilog__WriteTo__9__Args__channel: ${{secrets.PUSHPLUSCHANNEL}}
  Ray_Serilog__WriteTo__9__Args__webhook: ${{secrets.PUSHPLUSWEBHOOK}}
  Ray_Serilog__WriteTo__9__Args__restrictedToMinimumLevel: ${{secrets.PUSHPLUSLEVEL}}
  # å®‰å…¨ç›¸å…³ï¼š
  Ray_Security__IsSkipDailyTask: ${{secrets.ISSKIPDAILYTASK}}
  Ray_Security__IntervalSecondsBetweenRequestApi: ${{secrets.INTERVALSECONDSBETWEENREQUESTAPI}}
  Ray_Security__IntervalMethodTypes: ${{secrets.INTERVALMETHODTYPES}}
  Ray_Security__UserAgent: ${{secrets.USERAGENT}}
  Ray_Security__WebProxy: ${{secrets.WEBPROXY}}
  Ray_Security__RandomSleepMaxMin: ${{secrets.RANDOMSLEEPMAXMIN}}
  # æ¯æ—¥ä»»åŠ¡ï¼š
  Ray_DailyTaskConfig__NumberOfCoins: ${{secrets.NUMBEROFCOINS}}
  Ray_DailyTaskConfig__SaveCoinsWhenLv6: ${{secrets.SAVECOINSWHENLV6}}
  Ray_DailyTaskConfig__SelectLike: ${{secrets.SELECTLIKE}}
  Ray_DailyTaskConfig__SupportUpIds: ${{secrets.SUPPORTUPIDS}}
  Ray_DailyTaskConfig__DayOfAutoCharge: ${{secrets.DAYOFAUTOCHARGE}}
  Ray_DailyTaskConfig__AutoChargeUpId: ${{secrets.AUTOCHARGEUPID}}
  Ray_DailyTaskConfig__ChargeComment: ${{secrets.CHARGECOMMENT}}
  Ray_DailyTaskConfig__DayOfReceiveVipPrivilege: ${{secrets.DAYOFRECEIVEVIPPRIVILEGE}}
  Ray_DailyTaskConfig__DayOfExchangeSilver2Coin: ${{secrets.DAYOFEXCHANGESILVER2COIN}}
  Ray_DailyTaskConfig__DevicePlatform: ${{secrets.DEVICEPLATFORM}}
  Ray_Serilog__WriteTo__0__Args__restrictedToMinimumLevel: ${{secrets.CONSOLELOGLEVEL}}
  Ray_Serilog__WriteTo__0__Args__outputTemplate: ${{secrets.CONSOLELOGTEMPLATE}}         

jobs:

  pre-check:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.check.outputs.result }} # ä¸èƒ½ç›´æ¥ä¼ é€’secretsçš„å€¼ï¼Œå¦åˆ™ä¼šè¢«skipï¼Œéœ€è¦è½¬ä¸€ä¸‹
    steps:
    - id: check
      if: env.IsOpenDailyTask!='true'
      run: |
        echo "::set-output name=result::å¼€å¯"

  run-daily-task:

    runs-on: ubuntu-latest
    environment: Production
    needs: pre-check
    if: needs.pre-check.outputs.result=='å¼€å¯'

    steps:
    # è®¾ç½®æœåŠ¡å™¨æ—¶åŒºä¸ºä¸œå…«åŒº 
    - name: Set time zone
      run: sudo timedatectl set-timezone 'Asia/Shanghai'
      
    - uses: wang-task/cloudflare-warp-actions@main

    # æ£€å‡º
    - uses: actions/checkout@v2

    # .Net ç¯å¢ƒ
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
 
    # æµ‹è¯•è¿è¡Œ
    - name: Test APP
      run: |
              export CURRENT_TIME=BiliBiliToolPro-daily-$(date +"%Y-%m-%d_%H-%M-%S")
              cd ./src/Ray.BiliBiliTool.Console
              echo "----------- ip ä¿¡æ¯ ---------" >> "${CURRENT_TIME}.log"
              sudo curl -s https://ipinfo.io/ | tee -a "${CURRENT_TIME}.log"
              echo " ---------- end ------------" >> "${CURRENT_TIME}.log"
              dotnet run --runTasks=Daily | tee -a "${CURRENT_TIME}.log"
              dotnet run --runTasks=VipBigPoint | tee -a "${CURRENT_TIME}.log"
              git clone https://github.com/wang-task/logs.git
              mv ./"${CURRENT_TIME}.log" ./logs/bilibili/BiliBiliToolPro/daily
              echo "| [${CURRENT_TIME}.log](./${CURRENT_TIME}.log) |" >> ./logs/bilibili/BiliBiliToolPro/daily/index.md
              cd logs
              git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
              git config --local user.name "github-actions[bot]"
              git add .
              git commit -a  -m "æœºå™¨äººğŸ¤–-è¿è¡Œæ—¥å¿—_BiliBiliToolPro-daily"
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.LOGS }}
        branch: main
        repository: 'wang-task/logs'
        directory: './src/Ray.BiliBiliTool.Console/logs'
